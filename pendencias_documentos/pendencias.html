<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendência de Documentos | G&G</title>
    <link rel="icon" href="../icon.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../style.css?v=5"> <!-- Versão do CSS atualizada -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
        /* Estilos específicos para pendências */
        .header-pendencias {
            border-top: 4px solid var(--pendencia-bad);
        }
        .text-pendencia-bad { color: var(--pendencia-bad); }
        .text-pendencia-good { color: var(--pendencia-good); }

        .diff-up { color: var(--pendencia-bad); font-weight: bold; } /* Aumento é ruim (mais pendências) */
        .diff-down { color: var(--pendencia-good); font-weight: bold; } /* Queda é bom (menos pendências) */

        /* Estilo para a tabela de relatório pendente */
        .tabela .pendencia-baixa { color: var(--pendencia-good); } /* Verde */
        .tabela .pendencia-media { color: #f59e0b; } /* Amarelo */
        .tabela .pendencia-alta { color: var(--pendencia-bad); } /* Vermelho/Pink */
        
        .stat-card-dash .stat-change {
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        /* Ajuste do grid para 2 colunas após remoção da Seção */
        @media (min-width: 1024px) {
            /* NOVO: Força o grid de 2 colunas para os gráficos */
            .report-grid-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="appShell" class="h-screen flex flex-col" style="display: none;">

        <header id="topBar" class="flex-shrink-0">
            <div class="flex items-center gap-4">
                <button id="sidebarToggle" class="btn-icon">
                    <i data-feather="menu" class="h-5 w-5"></i>
                </button>
                <img src="../icon.png" class="h-8 w-auto" alt="Logo G&G">
                <div class="separator"></div>
                <div class="flex flex-col">
                    <span class="text-sm font-semibold text-white" id="topBarProjectName">Sistema G&G</span>
                    <span class="text-xs text-gray-400" id="topBarOrgName">Pendência de Documentos</span>
                </div>
            </div>
            
            <div class="flex-1 flex justify-center px-8">
            </div>
            
            <div class="flex items-center gap-4">
                <div id="profileDropdown" class="relative">
                    <button id="profileDropdownButton" class="flex items-center gap-2 rounded-full hover:bg-gray-700 p-1">
                        <img id="topBarUserAvatar" src="https://i.imgur.com/80SsE11.png" class="w-8 h-8 rounded-full object-cover bg-gray-600">
                        <span id="topBarUserName" class="text-sm font-medium text-white hidden md:block">Usuário</span>
                        <i data-feather="chevron-down" class="h-4 w-4 text-gray-400 hidden md:block"></i>
                    </button>
                    <div id="profileDropdownMenu" class="dropdown-menu">
                         <div class="px-4 py-3 border-b border-gray-600">
                            <span class="block text-sm font-medium text-white" id="dropdownUserName">...</span>
                            <span class="block text-xs text-gray-400" id="dropdownUserEmail">...</span>
                        </div>
                        <a href="../home.html" class="dropdown-item">
                            <i data-feather="home" class="h-4 w-4 mr-2"></i> Voltar (Home G&G)
                        </a>
                        <div class="border-t border-gray-600">
                            <a href="#" class="dropdown-item text-red-400" id="logoutButton">
                                <i data-feather="log-out" class="h-4 w-4 mr-2"></i> Sair
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="mainSystem" class="flex flex-1 overflow-hidden">

            <aside class="sidebar collapsed">
                <nav class="p-2 pt-4">
                    <a href="#dashboard" class="nav-item active" title="Dashboard Pendências">
                        <i data-feather="alert-triangle" class="h-5 w-5 mr-3"></i> <span class="nav-text">Dashboard</span>
                    </a>
                    <a href="#acompanhamento" class="nav-item" title="Acompanhamento Detalhado">
                        <i data-feather="list" class="h-5 w-5 mr-3"></i> <span class="nav-text">Pendentes Detalhes</span>
                    </a>
                    
                    <a href="#configuracoes" id="configLink" class="nav-item" title="Configurações" style="display: none;">
                        <i data-feather="settings" class="h-5 w-5 mr-3"></i> <span class="nav-text">Configurações</span>
                    </a>

                     <a href="#" id="logoutLink" class="nav-item" title="Sair">
                        <i data-feather="log-out" class="h-5 w-5 mr-3 text-red-400"></i> <span class="nav-text text-red-400">Sair</span>
                    </a>
                </nav>
            </aside>
            
            <div id="sidebarOverlay"></div>

            <main class="main-content">
                <div class="container mx-auto px-6 py-8">
                
                    <div id="dashboardView" class="view-content active">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <h1><i data-feather="alert-triangle" class="h-7 w-7 text-pendencia-bad"></i> Dashboard Pendências de Documentos</h1>
                            <div class="text-sm text-gray-600">
                                <strong>Última Importação:</strong>
                                <span id="lastUpdatedDash" class="font-medium" style="color: var(--accent);">Buscando...</span>
                            </div>
                        </div>

                        <div class="filter-bar">
                            <div class="form-group">
                                <label for="filterMesDash">Filtrar por Mês de Criação</label>
                                <select id="filterMesDash">
                                    <option value="">Todos os meses</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterRegionalDash">Filtrar por Regional</label>
                                <select id="filterRegionalDash">
                                    <option value="">Todas as regionais</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterCodFilialDash">Filtrar por Cód. Filial</label>
                                <select id="filterCodFilialDash">
                                    <option value="">Todas as filiais</option>
                                </select>
                            </div>
                        </div>

                        <div class="info-card flex flex-col md:flex-row justify-between items-start header-pendencias">
                            <div class="mb-4 md:mb-0 md:w-1/2">
                                <h3><i data-feather="target" class="h-5 w-5 mr-2"></i> Meta de Regularização Mensal</h3>
                                <p class="text-sm text-gray-600 mt-2">
                                    A meta é manter a % de pendências (documentos criados no mês **e** não assinados) abaixo de 
                                    <strong class="text-pendencia-good" id="metaPorcentagem">3.0%</strong>.
                                </p>
                                <div class="mt-2 text-xs text-gray-500">
                                    **Cálculo:** (Total Pendências do Mês / Total de Documentos Criados no Mês)
                                </div>
                            </div>
                            <div class="md:w-1/2 md:pl-8">
                                <h3 class="!mt-0">Resultado Mensal (<span id="mesReferenciaMeta">...</span>)</h3>
                                <div id="metaProgressContainer">
                                    <div class="progress-bar-meta-pendencias">
                                        <div class="progress-fill-pendencias" id="progressFillMeta"></div>
                                    </div>
                                    <div class="flex justify-between text-sm mt-1 font-semibold">
                                        <span>Pendências: <strong id="pendenciasMesAtual" class="text-pendencia-bad">0</strong></span>
                                        <span>Total Criado: <strong id="totalCriadoMesAtual">0</strong></span>
                                        <span>% Pendente: <strong id="percentualPendente" class="text-pendencia-bad">0.0%</strong></span>
                                    </div>
                                    <div class="text-lg font-bold mt-2 text-right" id="statusMeta"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- REMOVIDO: Gráfico de Pendência por Seção -->
                        <!-- ATUALIZADO: Grid para 2 colunas (report-grid-2) -->
                        <div class="report-grid report-grid-2">
                            <div class="chart-card">
                                <h3><i data-feather="bar-chart"></i> % Pendência por Filial</h3> <!-- MUDANÇA: Agora é gráfico de barras -->
                                <div class="chart-container-wrapper" style="height: 350px;">
                                    <canvas id="chartRankingFilial"></canvas> 
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3><i data-feather="pie-chart"></i> % Pendência por Função</h3>
                                <div class="chart-container-wrapper" style="height: 350px;">
                                    <canvas id="chartRankingFuncao"></canvas> 
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i data-feather="bar-chart-2"></i> Evolução das Pendências por Mês (Baseado na Data de Criação)</h3>
                            <div class="chart-container-wrapper" style="height: 350px;">
                                <canvas id="chartPendenciasMensais"></canvas>
                            </div>
                        </div>

                        <div class="info-card">
                            <h3><i data-feather="zap" class="h-5 w-5 mr-2"></i> Ranking de Filiais por Pendência</h3>
                            <p class="text-sm text-gray-600 -mt-4 mb-4">Acompanhamento das filiais com o maior número de pendências e o índice.</p>
                            <div id="tableRankingContainer" class="table-container mt-4">
                                <table class="tabela text-center" id="tableRankingFilialPendencias">
                                    <thead>
                                        <tr>
                                            <th>Filial</th>
                                            <th>Regional</th>
                                            <th>Total Doc.</th>
                                            <th>Total Pendente</th>
                                            <th>% Pendente</th>
                                            <th>Índice</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableRankingFilialBody">
                                        <tr><td colspan="6" class="text-center py-5 text-gray-500">Selecione um mês para análise.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="acompanhamentoView" class="view-content">
                        <div class="info-card">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h3 class="!mb-0 !pb-0 !border-b-0"><i data-feather="list" class="h-5 w-5 mr-2"></i> Documentos Ainda Pendentes</h3>
                            </div>

                            <div class="filter-bar mt-4">
                                <div class="form-group">
                                    <label for="filterNomeAcomp">Filtrar por Nome/Chapa</label>
                                    <input type="text" id="filterNomeAcomp" placeholder="Nome ou chapa..." >
                                </div>
                                <div class="form-group">
                                    <label for="filterRegionalAcomp">Filtrar por Regional</label>
                                    <select id="filterRegionalAcomp">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="filterCodFilialAcomp">Filtrar por Cód. Filial</label>
                                    <select id="filterCodFilialAcomp">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                 <div class="form-group">
                                    <label for="filterDocumentoAcomp">Filtrar por Documento</label>
                                    <select id="filterDocumentoAcomp">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                            </div>

                            <div id="tableContainer" class="table-container mt-6">
                                <table class="tabela">
                                    <thead id="tableHeadAcomp"></thead>
                                    <tbody id="tableBodyAcomp">
                                        <tr><td colspan="10" class="text-center py-10 text-gray-500">Nenhum filtro aplicado ou dados não carregados.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <p id="tableMessageAcomp" class="hidden text-center py-10 text-gray-500">Nenhum dado encontrado para os filtros aplicados.</p>
                        </div>
                    </div>

                    <!-- Conteúdo: Configurações -->
                    <div id="configuracoesView" class="view-content">
                        <div id="accessStatusConfig" class="access-status" style="display: none;"></div>
                        <div id="adminPanel" class="info-card mb-6 header-pendencias">
                            <h3><i data-feather="settings" class="h-5 w-5 mr-2"></i> Área Administrativa: Importar Documentos</h3>
                            <p class="text-gray-600 mb-4">Cole os dados de pendência de documentos abaixo. A primeira linha deve ser o cabeçalho. As colunas obrigatórias são: `BANDEIRA`, `REGIONAL`, `CODFILIAL`, `DOCUMENTO`, `CHAPA`, `NOME`, `FUNCAO`, `DATA_CRIACAO`, `DATA_ASSINATURA`, `DESC_STATUS`.</p>
                            
                            <div id="importError" class="hidden alert alert-error mb-4" role="alert">
                                <strong class="font-bold">Erro na Importação:</strong>
                                <span class="block sm:inline" id="importErrorMessage"></span>
                            </div>

                            <div class="form-group">
                                <label for="dataInput">Dados para importação:</label>
                                <textarea id="dataInput" class="w-full h-48" placeholder="Cole os dados aqui..."></textarea>
                            </div>
                            
                            <div class="flex items-center gap-4 mt-4">
                                <button id="previewButton" class="btn btn-info flex items-center gap-2">
                                    <i data-feather="search" class="h-5 w-5"></i>
                                    Pré-visualizar 15 Linhas
                                </button>
                                <button id="importButton" class="btn btn-danger flex items-center gap-2">
                                    <i data-feather="upload" class="h-5 w-5"></i>
                                    Importar e Limpar Base
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2"><strong>Atenção:</strong> A importação **limpará** a base atual e a substituirá pelos dados colados.</p>
                        
                            <div id="previewContainer" class="mt-6" style="display: none;">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">Pré-visualização</h4>
                                <div id="previewTableContainer" class="table-container">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </main>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Processando...</p>
    </div>

    <script src="pendencias.js" defer></script>
</body>
</html>

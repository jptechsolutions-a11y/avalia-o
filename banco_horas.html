<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Horas | G&G</title>
    <link rel="icon" href="icon.png" type="image/png">
    
    <!-- Scripts de Estilo e Ícones (Padrão do App) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css?v=2"> <!-- Usando o style.css principal -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Estilos específicos do banco_horas.html (mantidos) */
        .diff-up {
            color: #16a34a; /* Verde */
            font-weight: bold;
        }
        .diff-down {
            color: #dc2626; /* Vermelho */
            font-weight: bold;
        }
        .diff-same {
            color: #6b7280; /* Cinza */
        }
    </style>
</head>
<body class="bg-gray-100"> <!-- Classe padrão do app.html -->

    <!-- Shell principal (do app.html) -->
    <div id="appShell" class="h-screen flex flex-col" style="display: none;">

        <!-- Header (Copiado do app.html e adaptado) -->
        <header id="topBar" class="flex-shrink-0">
            <div class="flex items-center gap-4">
                <button id="sidebarToggle" class="btn-icon">
                    <i data-feather="menu" class="h-5 w-5"></i>
                </button>
                <img src="icon.png" class="h-8 w-auto" alt="Logo G&G">
                <div class="separator"></div>
                <div class="flex flex-col">
                    <span class="text-sm font-semibold text-white" id="topBarProjectName">Sistema G&G</span>
                    <span class="text-xs text-gray-400" id="topBarOrgName">Banco de Horas</span>
                </div>
            </div>
            
            <div class="flex-1 flex justify-center px-8">
                <!-- Espaço vazio central -->
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Botão de "Nova Avaliação" removido -->
                <div id="profileDropdown" class="relative">
                    <button id="profileDropdownButton" class="flex items-center gap-2 rounded-full hover:bg-gray-700 p-1">
                        <img id="topBarUserAvatar" src="https://i.imgur.com/80SsE11.png" class="w-8 h-8 rounded-full object-cover bg-gray-600">
                        <span id="topBarUserName" class="text-sm font-medium text-white hidden md:block">Usuário</span>
                        <i data-feather="chevron-down" class="h-4 w-4 text-gray-400 hidden md:block"></i>
                    </button>
                    <div id="profileDropdownMenu" class="dropdown-menu">
                         <div class="px-4 py-3 border-b border-gray-600">
                            <span class="block text-sm font-medium text-white" id="dropdownUserName">...</span>
                            <span class="block text-xs text-gray-400" id="dropdownUserEmail">...</span>
                        </div>
                        <a href="home.html" class="dropdown-item">
                            <i data-feather="home" class="h-4 w-4 mr-2"></i> Voltar (Home G&G)
                        </a>
                        <div class="border-t border-gray-600">
                            <a href="#" class="dropdown-item text-red-400" id="logoutButton">
                                <i data-feather="log-out" class="h-4 w-4 mr-2"></i> Sair
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main System (Copiado do app.html) -->
        <div id="mainSystem" class="flex flex-1 overflow-hidden">

            <!-- Sidebar (Copiado do app.html e adaptado) -->
            <aside class="sidebar collapsed">
                <nav class="p-2 pt-4">
                    <a href="#acompanhamento" class="nav-item active" title="Acompanhamento"> <!-- Marcado como ativo -->
                        <i data-feather="clock" class="h-5 w-5 mr-3"></i> <span class="nav-text">Acompanhamento</span>
                    </a>
                    <a href="#configuracoes" id="configLink" class="nav-item" title="Configurações" style="display: none;"> <!-- Oculto por padrão -->
                        <i data-feather="settings" class="h-5 w-5 mr-3"></i> <span class="nav-text">Configurações</span>
                    </a>

                    <div class="mt-4 border-t border-gray-700 pt-2">
                        <span class="p-3 text-xs font-semibold text-gray-500 nav-text">Navegação</span>
                    </div>
                    <a href="home.html" class="nav-item" title="Voltar (Home G&G)">
                        <i data-feather="home" class="h-5 w-5 mr-3"></i> <span class="nav-text">Home G&G</span>
                    </a>
                     <a href="#" id="logoutLink" class="nav-item" title="Sair">
                        <i data-feather="log-out" class="h-5 w-5 mr-3 text-red-400"></i> <span class="nav-text text-red-400">Sair</span>
                    </a>
                </nav>
            </aside>
            
            <div id="sidebarOverlay"></div>

            <!-- Main Content (Wrapper do app.html) -->
            <main class="main-content">
                <!-- Container (Wrapper do app.html) -->
                <div class="container mx-auto px-6 py-8">
                
                    <!-- CONTEÚDO ORIGINAL DO banco_horas.html INSERIDO AQUI -->
                    
                    <!-- View: Acompanhamento (Default) -->
                    <div id="acompanhamentoView" class="view-content active">
                        <!-- Data View Section - USANDO INFO-CARD -->
                        <div class="info-card">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <!-- Adaptado para não ter borda/padding inferior -->
                                <h3 class="!mb-0 !pb-0 !border-b-0"><i data-feather="clock" class="h-5 w-5 mr-2"></i> Acompanhamento do Banco de Horas</h3>
                                <div class="text-sm text-gray-600">
                                    <strong>Última Atualização:</strong>
                                    <span id="lastUpdated" class="font-medium" style="color: var(--accent);">Buscando...</span>
                                </div>
                            </div>

                            <!-- Filtros (Adaptados para o filter-bar do style.css) -->
                            <div class="filter-bar mt-4">
                                <div class="form-group">
                                    <label for="filterChapa">Filtrar por Chapa</label>
                                    <input type="text" id="filterChapa" placeholder="Digite a chapa...">
                                </div>
                                <div class="form-group">
                                    <label for="filterNome">Filtrar por Nome</label>
                                    <input type="text" id="filterNome" placeholder="Digite o nome...">
                                </div>
                                <div class="form-group">
                                    <label for="filterRegional">Filtrar por Regional</label>
                                    <input type="text" id="filterRegional" placeholder="Digite a regional...">
                                </div>
                                <div class="form-group">
                                    <label for="filterCodFilial">Filtrar por Cód. Filial</label>
                                    <input type="text" id="filterCodFilial" placeholder="Digite o cód. filial...">
                                </div>
                            </div>

                            <!-- Tabela - USANDO TABLE-CONTAINER E TABELA -->
                            <div id="tableContainer" class="table-container mt-6">
                                <table class="tabela">
                                    <thead id="tableHead">
                                        <!-- Cabeçalho será gerado pelo JS -->
                                    </thead>
                                    <tbody id="tableBody">
                                        <tr><td colspan="13" class="text-center py-10 text-gray-500">Carregando dados...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <p id="tableMessage" class="hidden text-center py-10 text-gray-500">Nenhum dado encontrado para os filtros aplicados.</p>
                        </div>
                    </div>

                    <!-- View: Configurações (Admin) -->
                    <div id="configuracoesView" class="view-content">
                        <!-- Admin Section - USANDO INFO-CARD (Movido para cá) -->
                        <div id="adminPanel" class="info-card mb-6"> <!-- Removido style="display: none;" -->
                            <h3><i data-feather="settings" class="h-5 w-5 mr-2"></i> Área Administrativa</h3>
                            <p class="text-gray-600 mb-4">Cole os dados do banco de horas abaixo (formato esperado: CSV ou separado por tabulação). A primeira linha deve ser o cabeçalho. Certifique-se de que os nomes das colunas correspondem: `REGIONAL`, `BANDEIRA`, `CODFILIAL`, `CHAPA`, `NOME`, `FUNCAO`, `SECAO`, `TOTAL_EM_HORA`, `TOTAL_NEGATIVO`, `VAL_PGTO_BHS`, `SITUACAO`, `Total Geral`.</p>
                            
                            <div id="importError" class="hidden alert alert-error mb-4" role="alert">
                                <strong class="font-bold">Erro na Importação:</strong>
                                <span class="block sm:inline" id="importErrorMessage"></span>
                            </div>

                            <!-- Aplicadas classes do style.css -->
                            <div class="form-group">
                                <label for="dataInput">Dados para importação:</label>
                                <textarea id="dataInput" class="w-full h-48" placeholder="Cole os dados aqui..."></textarea>
                            </div>
                            
                            <button id="importButton" class="mt-4 btn btn-success flex items-center gap-2">
                                <i data-feather="upload" class="h-5 w-5"></i>
                                Importar e Atualizar Dados
                            </button>
                            <p class="text-xs text-gray-500 mt-2"><strong>Atenção:</strong> Isso salvará os dados atuais no histórico e substituirá a base principal pelos novos dados.</p>
                        </div>
                    </div>
                    
                    <!-- FIM DO CONTEÚDO ORIGINAL -->

                </div>
            </main>
        </div>
    </div>

    <!-- Container de Notificações (Padrão app.html) -->
    <div id="notificationContainer"></div>

    <!-- Modal Detalhes (Original do banco_horas.html, já compatível) -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span id="modalClose" class="modal-close">&times;</span>
            <h3 id="modalTitle">Detalhes do Colaborador</h3>
            <div id="modalBody" class="space-y-4 mt-4">
                <p><strong>Nome:</strong> <span id="modalNome">...</span></p>
                <p><strong>Chapa:</strong> <span id="modalChapa">...</span></p>
                
                <hr>
                <h4 class="text-lg font-semibold text-gray-800">Comparativo da Atualização</h4>
                <div id="modalComparison">
                    <!-- Conteúdo do comparativo será injetado aqui -->
                </div>
                <div id="modalNoHistory" class="hidden text-gray-500 italic">
                    Nenhum histórico anterior encontrado para comparação.
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay (Padrão app.html) -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Processando...</p>
    </div>

    <!-- JS do Sistema (Script inline do banco_horas.html adaptado) -->
    <script>
        // Mapeamento de Cabeçalhos
        const COLUMN_MAP = {
            'CHAPA': 'Chapa', 'NOME': 'Nome', 'REGIONAL': 'Regional', 'BANDEIRA': 'Bandeira',
            'CODFILIAL': 'Cód. Filial', 'FUNCAO': 'Função', 'SECAO': 'Seção', 
            'TOTAL_EM_HORA': 'Total (Hora)', 'TOTAL_NEGATIVO': 'Total Negativo',
            'VAL_PGTO_BHS': 'Valor Pgto. BH', 'SITUACAO': 'Situação', 'Total Geral': 'Total Geral'
        };
        const COLUMN_ORDER = [
            'CHAPA', 'NOME', 'REGIONAL', 'BANDEIRA', 'CODFILIAL', 'FUNCAO', 'SECAO', 
            'TOTAL_EM_HORA', 'TOTAL_NEGATIVO', 'VAL_PGTO_BHS', 'SITUACAO', 'Total Geral'
        ];

        // Configuração do Supabase (igual ao login.js e home.html)
        const SUPABASE_URL = 'https://xizamzncvtacaunhmsrv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpemFtem5jdnRhY2F1bmhtc3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NTM3MTQsImV4cCI6MjA3NzQyOTcxNH0.tNZhQiPlpQCeFTKyahFOq_q-5i3_94AHpmIjYYrnTc8';
        
        // ADICIONADO: URL do Proxy
        const SUPABASE_PROXY_URL = '/api/proxy';
        
        let supabaseClient = null;
        const sessionStorageAdapter = {
          getItem: (key) => sessionStorage.getItem(key),
          setItem: (key, value) => sessionStorage.setItem(key, value),
          removeItem: (key) => sessionStorage.removeItem(key),
        };

        // --- ADICIONADO: Função de Requisição via Proxy ---
        async function supabaseRequest(endpoint, method = 'GET', body = null, headers = {}) {
            // Usa o state.auth que será preenchido pelo initializeSupabase
            const authToken = state.auth ? state.auth.access_token : null; 
            if (!authToken) {
                console.error("Token JWT não encontrado no estado, deslogando.");
                logout(); // A função logout será definida mais abaixo
                throw new Error("Sessão expirada. Faça login novamente.");
            }
            
            const url = `${SUPABASE_PROXY_URL}?endpoint=${encodeURIComponent(endpoint)}`;
            
            const config = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`, 
                    ...headers 
                }
            };

            if (!config.headers['Prefer']) {
                config.headers['Prefer'] = 'return=representation';
            }

            if (body && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, config);

                if (!response.ok) {
                    let errorData = { message: `Erro ${response.status}: ${response.statusText}` };
                    try { 
                        errorData = await response.json(); 
                    } catch(e) {
                        // Resposta não-JSON
                    }
                    
                    console.error("Erro Supabase (via Proxy):", errorData);
                    const detailedError = errorData.message || errorData.error || `Erro na requisição (${response.status})`;
                    
                    if (response.status === 401) {
                        throw new Error("Não autorizado. Sua sessão pode ter expirado.");
                    }
                    throw new Error(detailedError);
                }

                if (config.headers['Prefer'] === 'count=exact') {
                    const countRange = response.headers.get('content-range'); 
                    const count = countRange ? countRange.split('/')[1] : '0';
                    return { count: parseInt(count || '0', 10) };
                }

                if (response.status === 204 || response.headers.get('content-length') === '0' ) {
                    return null; 
                }

                return await response.json(); 

            } catch (error) {
                console.error("Erro na função supabaseRequest:", error.message);
                if (error.message.includes("Não autorizado") || error.message.includes("expirada")) {
                    if(typeof logout === 'function') logout(); 
                }
                throw error; 
            }
        }
        // --- FIM DA FUNÇÃO ADICIONADA ---


        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da UI
            const ui = {
                appShell: document.getElementById('appShell'),
                userName: document.getElementById('topBarUserName'),
                dropdownUserName: document.getElementById('dropdownUserName'),
                dropdownUserEmail: document.getElementById('dropdownUserEmail'),
                userAvatar: document.getElementById('topBarUserAvatar'),
                adminPanel: document.getElementById('adminPanel'),
                importButton: document.getElementById('importButton'),
                dataInput: document.getElementById('dataInput'),
                importError: document.getElementById('importError'),
                importErrorMessage: document.getElementById('importErrorMessage'),
                lastUpdated: document.getElementById('lastUpdated'),
                tableHead: document.getElementById('tableHead'),
                tableBody: document.getElementById('tableBody'),
                tableMessage: document.getElementById('tableMessage'),
                filterChapa: document.getElementById('filterChapa'),
                filterNome: document.getElementById('filterNome'),
                filterRegional: document.getElementById('filterRegional'),
                filterCodFilial: document.getElementById('filterCodFilial'),
                modal: document.getElementById('detailsModal'),
                modalClose: document.getElementById('modalClose'),
                modalTitle: document.getElementById('modalTitle'),
                modalBody: document.getElementById('modalBody'),
                modalNome: document.getElementById('modalNome'),
                modalChapa: document.getElementById('modalChapa'),
                modalComparison: document.getElementById('modalComparison'),
                modalNoHistory: document.getElementById('modalNoHistory'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loadingText'),
                logoutButton: document.getElementById('logoutButton'),
                logoutLink: document.getElementById('logoutLink'),
                profileDropdown: document.getElementById('profileDropdown'),
                profileDropdownButton: document.getElementById('profileDropdownButton'),
                // Links e Views para navegação
                configLink: document.getElementById('configLink'),
                acompanhamentoView: document.getElementById('acompanhamentoView'),
                configuracoesView: document.getElementById('configuracoesView')
            };

            // Estado da Aplicação
            const state = {
                auth: null,
                userId: null,
                isAdmin: false,
                allData: [] // Cache local
            };

            // --- FUNÇÕES ---

            function showLoading(show, text = 'Processando...') {
                ui.loadingText.textContent = text;
                ui.loading.style.display = show ? 'flex' : 'none';
            }

            function showImportError(message) {
                ui.importErrorMessage.textContent = message;
                ui.importError.classList.remove('hidden');
            }

            function formatTimestamp(isoString) {
                if (!isoString) return 'N/A';
                return new Date(isoString).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }

            async function initializeSupabase() {
                try {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: {
                            storage: sessionStorageAdapter,
                            persistSession: true,
                            autoRefreshToken: true
                        }
                    });
                    
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (sessionError || !session) {
                        console.error("Sem sessão, redirecionando para login.", sessionError);
                        window.location.href = 'home.html'; // AJUSTE: Manda para home.html
                        return;
                    }

                    state.auth = session;
                    state.userId = session.user.id;

                    // --- ATUALIZAÇÃO: Usando o Proxy ---
                    const endpoint = `usuarios?auth_user_id=eq.${state.userId}&select=nome,role,profile_picture_url`;
                    let profile = null;
                    let profileError = null;

                    try {
                        const profileResponse = await supabaseRequest(endpoint, 'GET');
                        if (profileResponse && profileResponse.length > 0) {
                            profile = profileResponse[0];
                        } else {
                            profileError = { message: "Perfil não encontrado ou resposta vazia do proxy." };
                        }
                    } catch (err) {
                        profileError = err;
                    }
                    // --- FIM DA ATUALIZAÇÃO ---

                    if (profileError) {
                        console.warn("Erro ao buscar perfil (via proxy):", profileError.message);
                        const emailName = session.user.email.split('@')[0];
                        ui.userName.textContent = emailName;
                        ui.dropdownUserName.textContent = emailName;
                        ui.dropdownUserEmail.textContent = session.user.email;
                    } else {
                        const nome = profile.nome || session.user.email.split('@')[0];
                        ui.userName.textContent = nome;
                        ui.dropdownUserName.textContent = nome;
                        ui.dropdownUserEmail.textContent = session.user.email;
                        if (profile.profile_picture_url) {
                            ui.userAvatar.src = profile.profile_picture_url;
                        }
                        state.isAdmin = (profile.role === 'admin');
                    }
                    
                    // Mostra/oculta painel admin e exibe o app
                    ui.configLink.style.display = state.isAdmin ? 'block' : 'none'; // Mostra/Oculta o LINK
                    ui.appShell.style.display = 'flex';
                    document.body.classList.add('system-active');


                } catch (err) {
                    console.error("Erro na inicialização do Supabase:", err);
                    showLoading(false);
                    alert("Erro crítico ao conectar. Verifique o console.");
                }
            }

            function logout() {
                if (supabaseClient) {
                    supabaseClient.auth.signOut().then(() => {
                        window.location.href = 'home.html'; // AJUSTE: Manda para home.html
                    }).catch((error) => {
                        console.error("Erro ao sair:", error);
                        window.location.href = 'home.html'; // AJUSTE: Manda para home.html
                    });
                } else {
                    window.location.href = 'home.html'; // AJUSTE: Manda para home.html
                }
            }

            async function listenToMetadata() {
                const { data, error } = await supabaseClient
                    .from('banco_horas_meta')
                    .select('lastUpdatedAt')
                    .eq('id', 1)
                    .single();
                
                if (data) {
                    ui.lastUpdated.textContent = formatTimestamp(data.lastUpdatedAt);
                } else {
                    ui.lastUpdated.textContent = 'Nenhuma atualização registrada.';
                    console.warn("Erro ao buscar metadados:", error);
                }
            }

            // --- Nova Função: showView ---
            function showView(viewId, element) {
                document.querySelectorAll('.view-content').forEach(view => view.classList.remove('active'));
                const viewEl = document.getElementById(viewId);
                if(viewEl) viewEl.classList.add('active');

                document.querySelectorAll('.sidebar nav .nav-item').forEach(item => item.classList.remove('active'));
                if (element) {
                    element.classList.add('active');
                }

                const newHash = '#' + viewId.replace('View', '');
                if (window.location.hash !== newHash) {
                    history.pushState(null, '', newHash);
                }

                // Fecha o dropdown de perfil se estiver aberto
                if (ui.profileDropdown) ui.profileDropdown.classList.remove('open');
                
                // Carrega dados específicos da view
                if (viewId === 'acompanhamentoView') {
                    // Carrega os dados da tabela só na primeira vez que a view é aberta
                    if (state.allData.length === 0) { 
                        listenToMetadata();
                        renderTableHeader();
                        loadAllData();
                    }
                } else if (viewId === 'configuracoesView') {
                    // A view de config é só HTML, não precisa carregar dados
                }
                feather.replace();
            }

            // --- Nova Função: handleHashChange ---
            function handleHashChange() {
                if (!state.auth) return; // Não faz nada se não estiver logado
                
                const hash = window.location.hash || '#acompanhamento';
                let viewId = 'acompanhamentoView';
                let navElement = document.querySelector('a[href="#acompanhamento"]');

                if (hash === '#configuracoes' && state.isAdmin) {
                    viewId = 'configuracoesView';
                    navElement = document.querySelector('a[href="#configuracoes"]');
                }
                
                const currentActive = document.querySelector('.view-content.active');
                if (!currentActive || currentActive.id !== viewId) {
                    showView(viewId, navElement);
                }
            }


            function renderTableHeader() {
                const tr = document.createElement('tr');
                COLUMN_ORDER.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = COLUMN_MAP[key] || key;
                    tr.appendChild(th);
                });
                const thAction = document.createElement('th');
                thAction.textContent = 'Ações';
                tr.appendChild(thAction);
                ui.tableHead.innerHTML = '';
                ui.tableHead.appendChild(tr);
            }

            async function loadAllData() {
                showLoading(true, 'Carregando dados...');
                try {
                    const { data, error } = await supabaseClient
                        .from('banco_horas_data')
                        .select('*');

                    if (error) throw error;
                    
                    state.allData = data;
                    applyFilters();
                } catch (err) {
                    console.error("Erro ao carregar dados:", err);
                } finally {
                    showLoading(false);
                }
            }

            function applyFilters() {
                const filterChapa = ui.filterChapa.value.toLowerCase();
                const filterNome = ui.filterNome.value.toLowerCase();
                const filterRegional = ui.filterRegional.value.toLowerCase();
                const filterCodFilial = ui.filterCodFilial.value.toLowerCase();

                const filteredData = state.allData.filter(item => {
                    const chapa = String(item.CHAPA || '').toLowerCase();
                    const nome = String(item.NOME || '').toLowerCase();
                    const regional = String(item.REGIONAL || '').toLowerCase();
                    const codfilial = String(item.CODFILIAL || '').toLowerCase();

                    return (filterChapa === '' || chapa.includes(filterChapa)) &&
                           (filterNome === '' || nome.includes(filterNome)) &&
                           (filterRegional === '' || regional.includes(filterRegional)) &&
                           (filterCodFilial === '' || codfilial.includes(filterCodFilial));
                });

                renderTableBody(filteredData);
            }

            function renderTableBody(data) {
                ui.tableBody.innerHTML = '';
                if (data.length === 0) {
                    ui.tableMessage.classList.remove('hidden');
                    return;
                }

                ui.tableMessage.classList.add('hidden');
                const fragment = document.createDocumentFragment();

                data.forEach(item => {
                    const tr = document.createElement('tr');
                    COLUMN_ORDER.forEach(key => {
                        const td = document.createElement('td');
                        td.textContent = item[key] || '-';
                        tr.appendChild(td);
                    });

                    const tdAction = document.createElement('td');
                    const viewButton = document.createElement('button');
                    // Aplicando classes de botão do style.css
                    viewButton.innerHTML = '<i data-feather="eye" class="h-4 w-4"></i>';
                    viewButton.className = "btn btn-sm btn-info"; 
                    viewButton.title = "Ver Detalhes e Comparar";
                    viewButton.onclick = () => showDetails(item.CHAPA);
                    tdAction.appendChild(viewButton);
                    
                    tr.appendChild(tdAction);
                    fragment.appendChild(tr);
                });

                ui.tableBody.appendChild(fragment);
                feather.replace();
            }

            function resetModal() {
                ui.modalNome.textContent = '...';
                ui.modalChapa.textContent = '...';
                ui.modalComparison.innerHTML = '';
                ui.modalNoHistory.classList.add('hidden');
            }

            function createComparisonRow(label, oldVal, newVal) {
                oldVal = oldVal || 0;
                newVal = newVal || 0;
                
                let diff = 0;
                let diffClass = 'diff-same';
                
                const oldNum = parseFloat(String(oldVal).replace(',', '.'));
                const newNum = parseFloat(String(newVal).replace(',', '.'));

                if (!isNaN(oldNum) && !isNaN(newNum)) {
                    diff = newNum - oldNum;
                    if (diff > 0) diffClass = 'diff-up';
                    else if (diff < 0) diffClass = 'diff-down';
                }
                
                // Arredonda para 2 casas decimais apenas se for decimal
                const diffText = diff % 1 !== 0 ? diff.toFixed(2) : diff.toString();
                const diffDisplay = diff > 0 ? `+${diffText}` : diffText;


                return `
                    <div class="grid grid-cols-3 gap-2 p-2 rounded-md ${diff !== 0 ? 'bg-gray-100' : ''}">
                        <span class="font-medium text-gray-700">${label}:</span>
                        <span class="text-gray-600">${oldVal}</span>
                        <span class="font-bold">${newVal} <span class="${diffClass}">(${diff === 0 ? '-' : diffDisplay})</span></span>
                    </div>
                `;
            }

            async function showDetails(chapa) {
                resetModal();
                ui.modal.style.display = 'flex'; // Alterado para 'flex'
                showLoading(true, 'Buscando detalhes...');

                try {
                    const { data: currentData, error: currentError } = await supabaseClient
                        .from('banco_horas_data')
                        .select('*')
                        .eq('CHAPA', chapa)
                        .single();
                    
                    if (currentError) throw currentError;

                    ui.modalTitle.textContent = `Detalhes: ${currentData.NOME}`;
                    ui.modalNome.textContent = currentData.NOME;
                    ui.modalChapa.textContent = currentData.CHAPA;

                    const { data: historyData, error: historyError } = await supabaseClient
                        .from('banco_horas_history')
                        .select('data')
                        .order('timestamp', { ascending: false })
                        .limit(1);

                    if (historyError) throw historyError;

                    if (!historyData || historyData.length === 0) {
                        ui.modalNoHistory.classList.remove('hidden');
                    } else {
                        const oldData = historyData[0].data.find(item => item.CHAPA === chapa);

                        if (oldData) {
                            let comparisonHTML = `
                                <div class="grid grid-cols-3 gap-2 p-2 font-bold text-gray-500 text-sm">
                                    <span>Campo</span>
                                    <span>Valor Anterior</span>
                                    <span>Valor Atual (Diferença)</span>
                                </div>
                            `;
                            comparisonHTML += createComparisonRow('Total (Hora)', oldData.TOTAL_EM_HORA, currentData.TOTAL_EM_HORA);
                            comparisonHTML += createComparisonRow('Total Negativo', oldData.TOTAL_NEGATIVO, currentData.TOTAL_NEGATIVO);
                            comparisonHTML += createComparisonRow('Valor Pgto. BH', oldData.VAL_PGTO_BHS, currentData.VAL_PGTO_BHS);
                            comparisonHTML += createComparisonRow('Total Geral', oldData['Total Geral'], currentData['Total Geral']);

                            ui.modalComparison.innerHTML = comparisonHTML;
                        } else {
                            ui.modalNoHistory.classList.remove('hidden');
                        }
                    }

                } catch (err) {
                    console.error("Erro ao buscar detalhes:", err);
                    ui.modalBody.innerHTML = `<p class="alert alert-error">${err.message}</p>`;
                } finally {
                    showLoading(false);
                }
            }

            function parsePastedData(text) {
                const lines = text.trim().split('\n');
                if (lines.length < 2) throw new Error("Os dados precisam de pelo menos 2 linhas (cabeçalho e dados).");

                const delimiter = lines[0].includes('\t') ? '\t' : ',';
                const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                
                const missingHeaders = COLUMN_ORDER.filter(col => !headers.includes(col));
                if (missingHeaders.length > 0) {
                    throw new Error(`Cabeçalhos faltando: ${missingHeaders.join(', ')}`);
                }

                const data = lines.slice(1).map(line => {
                    const values = line.split(delimiter).map(v => v.trim().replace(/"/g, ''));
                    const obj = {};
                    headers.forEach((header, index) => {
                        // Apenas adiciona colunas que estão no COLUMN_ORDER
                        if (COLUMN_ORDER.includes(header)) {
                             obj[header] = values[index] || null;
                        }
                    });
                    if (!obj.CHAPA) {
                        // Não lança erro, apenas ignora a linha
                        console.warn("Linha sem 'CHAPA' ignorada:", line);
                        return null;
                    }
                    return obj;
                }).filter(Boolean); // Remove linhas nulas (ignoradas)

                return data;
            }

            async function handleImport() {
                ui.importError.classList.add('hidden');
                const pastedData = ui.dataInput.value;
                if (!pastedData) {
                    showImportError("A área de texto está vazia.");
                    return;
                }

                let newData;
                try {
                    newData = parsePastedData(pastedData);
                } catch (err) {
                    showImportError(err.message);
                    return;
                }

                if (newData.length === 0) {
                    showImportError("Nenhum dado válido para importar.");
                    return;
                }

                showLoading(true, `Enviando ${newData.length} registros para o servidor...`);

                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (!session) throw new Error("Sessão inválida ou expirada.");

                    const response = await fetch('/api/import-banco-horas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify(newData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Erro do servidor: ${response.statusText}`);
                    }

                    const result = await response.json();

                    ui.dataInput.value = '';
                    await loadAllData(); 
                    await listenToMetadata(); 
                    showLoading(false);
                    // Substituir alert por notificação
                    alert(result.message || "Dados importados com sucesso!");

                } catch (err) {
                    console.error("Erro durante a importação:", err);
                    showLoading(false);
                    showImportError(`Erro fatal: ${err.message}. (Verifique se a API '/api/import-banco-horas' está criada)`);
                }
            }

            // --- INICIALIZAÇÃO E EVENTOS ---

            async function main() {
                showLoading(true, 'Conectando...');
                await initializeSupabase();
                if (state.auth) {
                    // ATUALIZADO: Chama o handleHashChange que carrega a view correta
                    handleHashChange(); 
                    window.addEventListener('hashchange', handleHashChange);

                    ui.importButton.addEventListener('click', handleImport);
                    ui.modalClose.addEventListener('click', () => ui.modal.style.display = 'none');
                    window.addEventListener('click', (event) => {
                        if (event.target == ui.modal) {
                            ui.modal.style.display = 'none';
                        }
                    });
 
                    // Eventos de Navegação da View
                    document.querySelector('a[href="#acompanhamento"]').addEventListener('click', (e) => {
                        e.preventDefault();
                        showView('acompanhamentoView', e.currentTarget);
                    });
                    document.querySelector('a[href="#configuracoes"]').addEventListener('click', (e) => {
                        e.preventDefault();
                        showView('configuracoesView', e.currentTarget);
                    });

                    [ui.filterChapa, ui.filterNome, ui.filterRegional, ui.filterCodFilial].forEach(input => {
                        input.addEventListener('input', applyFilters);
                    });

                    // Eventos de Logout
                    ui.logoutButton.addEventListener('click', logout);
                    ui.logoutLink.addEventListener('click', logout);
                    
                    // Eventos do Dropdown (copiado do app.html)
                    ui.profileDropdownButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        ui.profileDropdown.classList.toggle('open');
                    });
                    document.addEventListener('click', (e) => {
                        if (ui.profileDropdown && !ui.profileDropdown.contains(e.target)) {
                            ui.profileDropdown.classList.remove('open');
                        }
                    });
                }
            }

            main();
            
            // Lógica da Sidebar (copiado do app.html)
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (sidebarToggle && sidebar && sidebarOverlay) {
                sidebarToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.innerWidth <= 768) {
                        document.body.classList.toggle('sidebar-open');
                    } else {
                        sidebar.classList.toggle('collapsed');
                    }
                });
                
                sidebarOverlay.addEventListener('click', () => {
                    document.body.classList.remove('sidebar-open');
                });
            }
            
            // Substituir alert por notificação (opcional, mas bom)
            // window.alert = (message) => console.warn("alert() substituído:", message); 
            
            feather.replace(); // Chamada final
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Horas | G&G</title>
    <link rel="icon" href="icon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #00D4AA;
            --secondary: #00B4D8;
            --accent: #0077B6;
            --dark: #023047;
            --darker: #011627;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            width: 100%;
            min-width: 1200px; /* Garante que a tabela tenha uma largura mínima */
        }
        th, td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            text-align: left;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #4b5563;
        }
        tbody tr:hover {
            background-color: #f3f4f6;
        }
        /* Estilos do Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
        }
        .diff-up {
            color: #16a34a; /* Verde */
            font-weight: bold;
        }
        .diff-down {
            color: #dc2626; /* Vermelho */
            font-weight: bold;
        }
        .diff-same {
            color: #6b7280; /* Cinza */
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Spinner */
        .loading { display: none; flex-direction: column; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.7); z-index: 5000; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <a href="home.html" class="text-gray-600 hover:text-gray-900">
                <i data-feather="arrow-left" class="h-6 w-6"></i>
            </a>
            <img src="icon.png" alt="Logo G&G" class="h-8 w-auto">
            <h1 class="text-xl font-bold text-gray-800">Sistema de Banco de Horas</h1>
        </div>
        <div class="flex items-center gap-2 text-sm text-gray-500">
            <i data-feather="user" class="h-5 w-5"></i>
            <span id="userName">Carregando...</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto p-6">

        <!-- Admin Section -->
        <div id="adminPanel" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">Área Administrativa</h2>
            <p class="text-gray-600 mb-4">Cole os dados do banco de horas abaixo (formato esperado: CSV ou separado por tabulação). A primeira linha deve ser o cabeçalho. Certifique-se de que os nomes das colunas correspondem: `REGIONAL`, `BANDEIRA`, `CODFILIAL`, `CHAPA`, `NOME`, `FUNCAO`, `SECAO`, `TOTAL_EM_HORA`, `TOTAL_NEGATIVO`, `VAL_PGTO_BHS`, `SITUACAO`, `Total Geral`.</p>
            
            <div id="importError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Erro na Importação:</strong>
                <span class="block sm:inline" id="importErrorMessage"></span>
            </div>

            <textarea id="dataInput" class="w-full h-48 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent" placeholder="Cole os dados aqui..."></textarea>
            
            <button id="importButton" class="mt-4 bg-accent text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition-colors flex items-center gap-2">
                <i data-feather="upload" class="h-5 w-5"></i>
                Importar e Atualizar Dados
            </button>
            <p class="text-xs text-gray-500 mt-2"><strong>Atenção:</strong> Isso salvará os dados atuais no histórico e substituirá a base principal pelos novos dados.</p>
        </div>

        <!-- Data View Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold text-gray-900">Acompanhamento do Banco de Horas</h2>
                <div class="text-sm text-gray-600">
                    <strong>Última Atualização:</strong>
                    <span id="lastUpdated" class="font-medium text-accent">Buscando...</span>
                </div>
            </div>

            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="filterChapa" placeholder="Filtrar por Chapa..." class="p-2 border border-gray-300 rounded-md">
                <input type="text" id="filterNome" placeholder="Filtrar por Nome..." class="p-2 border border-gray-300 rounded-md">
                <input type="text" id="filterRegional" placeholder="Filtrar por Regional..." class="p-2 border border-gray-300 rounded-md">
                <input type="text" id="filterCodFilial" placeholder="Filtrar por Cód. Filial..." class="p-2 border border-gray-300 rounded-md">
            </div>

            <!-- Tabela -->
            <div id="tableContainer" class="table-responsive">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead id="tableHead">
                        <!-- Cabeçalho será gerado pelo JS -->
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="12" class="text-center py-10 text-gray-500">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="tableMessage" class="hidden text-center py-10 text-gray-500">Nenhum dado encontrado para os filtros aplicados.</p>
        </div>
    </main>

    <!-- Modal Detalhes -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span id="modalClose" class="modal-close">&times;</span>
            <h2 class="text-2xl font-semibold mb-4 text-gray-900" id="modalTitle">Detalhes do Colaborador</h2>
            <div id="modalBody" class="space-y-4">
                <p><strong>Nome:</strong> <span id="modalNome">...</span></p>
                <p><strong>Chapa:</strong> <span id="modalChapa">...</span></p>
                
                <hr>
                <h3 class="text-xl font-semibold text-gray-800">Comparativo da Atualização</h3>
                <div id="modalComparison">
                    <!-- Conteúdo do comparativo será injetado aqui -->
                </div>
                <div id="modalNoHistory" class="hidden text-gray-500 italic">
                    Nenhum histórico anterior encontrado para comparação.
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p class="text-gray-700 mt-4" id="loadingText">Processando...</p>
    </div>

    <!-- Firebase Config -->
    <script>
        // Essas variáveis serão injetadas pelo ambiente de produção
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'banco-de-horas-dev';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Configuração de fallback para desenvolvimento local (se necessário)
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>

    <!-- JS do Sistema -->
    <script>
        // Mapeamento de Cabeçalhos (o que o usuário vê vs. o nome no DB)
        const COLUMN_MAP = {
            'CHAPA': 'Chapa',
            'NOME': 'Nome',
            'REGIONAL': 'Regional',
            'BANDEIRA': 'Bandeira',
            'CODFILIAL': 'Cód. Filial',
            'FUNCAO': 'Função',
            'SECAO': 'Seção',
            'TOTAL_EM_HORA': 'Total (Hora)',
            'TOTAL_NEGATIVO': 'Total Negativo',
            'VAL_PGTO_BHS': 'Valor Pgto. BH',
            'SITUACAO': 'Situação',
            'Total Geral': 'Total Geral' // Mantém o espaço se for o caso
        };
        // Ordem das colunas na tabela
        const COLUMN_ORDER = [
            'CHAPA', 'NOME', 'REGIONAL', 'BANDEIRA', 'CODFILIAL', 'FUNCAO', 'SECAO', 
            'TOTAL_EM_HORA', 'TOTAL_NEGATIVO', 'VAL_PGTO_BHS', 'SITUACAO', 'Total Geral'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Inicialização dos ícones
            feather.replace();

            // Elementos da UI
            const ui = {
                userName: document.getElementById('userName'),
                adminPanel: document.getElementById('adminPanel'),
                importButton: document.getElementById('importButton'),
                dataInput: document.getElementById('dataInput'),
                importError: document.getElementById('importError'),
                importErrorMessage: document.getElementById('importErrorMessage'),
                lastUpdated: document.getElementById('lastUpdated'),
                tableHead: document.getElementById('tableHead'),
                tableBody: document.getElementById('tableBody'),
                tableMessage: document.getElementById('tableMessage'),
                filterChapa: document.getElementById('filterChapa'),
                filterNome: document.getElementById('filterNome'),
                filterRegional: document.getElementById('filterRegional'),
                filterCodFilial: document.getElementById('filterCodFilial'),
                modal: document.getElementById('detailsModal'),
                modalClose: document.getElementById('modalClose'),
                modalTitle: document.getElementById('modalTitle'),
                modalBody: document.getElementById('modalBody'),
                modalNome: document.getElementById('modalNome'),
                modalChapa: document.getElementById('modalChapa'),
                modalComparison: document.getElementById('modalComparison'),
                modalNoHistory: document.getElementById('modalNoHistory'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loadingText')
            };

            // Estado da Aplicação
            const state = {
                db: null,
                auth: null,
                userId: null,
                isAdmin: false, // Vamos assumir que não é admin por padrão
                allData: [] // Cache local dos dados da tabela
            };

            // Referências do Firestore
            const refs = {
                data: () => state.db.collection(`artifacts/${appId}/public/banco_horas_data`),
                doc: (chapa) => state.db.collection(`artifacts/${appId}/public/banco_horas_data`).doc(String(chapa)),
                history: () => state.db.collection(`artifacts/${appId}/public/banco_horas_history`),
                metadata: () => state.db.collection(`artifacts/${appId}/public/banco_horas_meta`).doc('main')
            };

            // --- FUNÇÕES ---

            /**
             * Mostra ou esconde o overlay de loading.
             */
            function showLoading(show, text = 'Processando...') {
                ui.loadingText.textContent = text;
                ui.loading.style.display = show ? 'flex' : 'none';
            }

            /**
             * Mostra um erro na caixa de importação.
             */
            function showImportError(message) {
                ui.importErrorMessage.textContent = message;
                ui.importError.classList.remove('hidden');
            }

            /**
             * Formata um Timestamp do Firestore.
             */
            function formatTimestamp(timestamp) {
                if (!timestamp) return 'N/A';
                return timestamp.toDate().toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }

            /**
             * Inicializa o Firebase e a Autenticação.
             */
            async function initializeFirebase() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    state.auth = firebase.auth();
                    state.db = firebase.firestore();
                    firebase.firestore().setLogLevel('debug');

                    if (initialAuthToken) {
                        await state.auth.signInWithCustomToken(initialAuthToken);
                    } else {
                        await state.auth.signInAnonymously();
                    }

                    state.userId = state.auth.currentUser.uid;
                    ui.userName.textContent = state.auth.currentUser.displayName || state.auth.currentUser.email || 'Usuário';

                    // TODO: Implementar verificação de admin real
                    // Por enquanto, todo mundo é admin para teste
                    state.isAdmin = true; 
                    ui.adminPanel.style.display = state.isAdmin ? 'block' : 'none';

                } catch (err) {
                    console.error("Erro na inicialização do Firebase:", err);
                    showLoading(false);
                    alert("Erro crítico ao conectar. Verifique o console.");
                }
            }

            /**
             * Escuta as atualizações de metadados (última atualização).
             */
            function listenToMetadata() {
                refs.metadata().onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        ui.lastUpdated.textContent = formatTimestamp(data.lastUpdatedAt);
                    } else {
                        ui.lastUpdated.textContent = 'Nenhuma atualização registrada.';
                    }
                }, (err) => {
                    console.error("Erro ao escutar metadados:", err);
                });
            }

            /**
             * Renderiza o cabeçalho da tabela dinamicamente.
             */
            function renderTableHeader() {
                const tr = document.createElement('tr');
                COLUMN_ORDER.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = COLUMN_MAP[key] || key;
                    tr.appendChild(th);
                });
                // Coluna de Ações
                const thAction = document.createElement('th');
                thAction.textContent = 'Ações';
                tr.appendChild(thAction);
                ui.tableHead.innerHTML = ''; // Limpa
                ui.tableHead.appendChild(tr);
            }

            /**
             * Carrega todos os dados do banco de horas e armazena localmente.
             */
            async function loadAllData() {
                showLoading(true, 'Carregando dados...');
                try {
                    const snapshot = await refs.data().get();
                    state.allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    applyFilters(); // Renderiza os dados filtrados
                } catch (err) {
                    console.error("Erro ao carregar dados:", err);
                } finally {
                    showLoading(false);
                }
            }

            /**
             * Aplica os filtros e renderiza a tabela.
             */
            function applyFilters() {
                const filterChapa = ui.filterChapa.value.toLowerCase();
                const filterNome = ui.filterNome.value.toLowerCase();
                const filterRegional = ui.filterRegional.value.toLowerCase();
                const filterCodFilial = ui.filterCodFilial.value.toLowerCase();

                const filteredData = state.allData.filter(item => {
                    const chapa = String(item.CHAPA || '').toLowerCase();
                    const nome = String(item.NOME || '').toLowerCase();
                    const regional = String(item.REGIONAL || '').toLowerCase();
                    const codfilial = String(item.CODFILIAL || '').toLowerCase();

                    return (filterChapa === '' || chapa.includes(filterChapa)) &&
                           (filterNome === '' || nome.includes(filterNome)) &&
                           (filterRegional === '' || regional.includes(filterRegional)) &&
                           (filterCodFilial === '' || codfilial.includes(filterCodFilial));
                });

                renderTableBody(filteredData);
            }

            /**
             * Renderiza o corpo da tabela com os dados.
             */
            function renderTableBody(data) {
                ui.tableBody.innerHTML = ''; // Limpa o corpo
                if (data.length === 0) {
                    ui.tableMessage.classList.remove('hidden');
                    return;
                }

                ui.tableMessage.classList.add('hidden');
                const fragment = document.createDocumentFragment();

                data.forEach(item => {
                    const tr = document.createElement('tr');
                    COLUMN_ORDER.forEach(key => {
                        const td = document.createElement('td');
                        td.textContent = item[key] || '-';
                        tr.appendChild(td);
                    });

                    // Célula de Ação
                    const tdAction = document.createElement('td');
                    const viewButton = document.createElement('button');
                    viewButton.innerHTML = '<i data-feather="eye" class="h-4 w-4"></i>';
                    viewButton.className = "p-1 text-accent hover:text-opacity-80";
                    viewButton.title = "Ver Detalhes e Comparar";
                    viewButton.onclick = () => showDetails(item.CHAPA);
                    tdAction.appendChild(viewButton);
                    
                    tr.appendChild(tdAction);
                    fragment.appendChild(tr);
                });

                ui.tableBody.appendChild(fragment);
                feather.replace(); // Atualiza os ícones
            }

            /**
             * Limpa e prepara o modal para exibição.
             */
            function resetModal() {
                ui.modalNome.textContent = '...';
                ui.modalChapa.textContent = '...';
                ui.modalComparison.innerHTML = '';
                ui.modalNoHistory.classList.add('hidden');
            }

            /**
             * Cria uma linha de comparação para o modal.
             */
            function createComparisonRow(label, oldVal, newVal) {
                oldVal = oldVal || 0;
                newVal = newVal || 0;
                
                let diff = 0;
                let diffClass = 'diff-same';
                
                // Tenta converter para número para calcular a diferença
                const oldNum = parseFloat(String(oldVal).replace(',', '.'));
                const newNum = parseFloat(String(newVal).replace(',', '.'));

                if (!isNaN(oldNum) && !isNaN(newNum)) {
                    diff = newNum - oldNum;
                    if (diff > 0) diffClass = 'diff-up';
                    else if (diff < 0) diffClass = 'diff-down';
                }

                const diffText = diff > 0 ? `+${diff.toFixed(2)}` : diff.toFixed(2);

                return `
                    <div class="grid grid-cols-3 gap-2 p-2 rounded-md ${diff !== 0 ? 'bg-gray-100' : ''}">
                        <span class="font-medium text-gray-700">${label}:</span>
                        <span class="text-gray-600">${oldVal}</span>
                        <span class="font-bold">${newVal} <span class="${diffClass}">(${diff === 0 ? '-' : diffText})</span></span>
                    </div>
                `;
            }

            /**
             * Busca e exibe os detalhes de um colaborador.
             */
            async function showDetails(chapa) {
                resetModal();
                ui.modal.style.display = 'block';
                showLoading(true, 'Buscando detalhes...');

                try {
                    // 1. Buscar dados atuais
                    const docSnap = await refs.doc(chapa).get();
                    if (!docSnap.exists) {
                        throw new Error("Colaborador não encontrado.");
                    }
                    const currentData = docSnap.data();
                    ui.modalTitle.textContent = `Detalhes: ${currentData.NOME}`;
                    ui.modalNome.textContent = currentData.NOME;
                    ui.modalChapa.textContent = currentData.CHAPA;

                    // 2. Buscar último histórico
                    const historySnap = await refs.history()
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                    
                    if (historySnap.empty) {
                        ui.modalNoHistory.classList.remove('hidden');
                    } else {
                        const lastHistoryDoc = historySnap.docs[0].data();
                        const oldData = lastHistoryDoc.data.find(item => item.CHAPA === chapa);

                        if (oldData) {
                            let comparisonHTML = `
                                <div class="grid grid-cols-3 gap-2 p-2 font-bold text-gray-500 text-sm">
                                    <span>Campo</span>
                                    <span>Valor Anterior</span>
                                    <span>Valor Atual (Diferença)</span>
                                </div>
                            `;
                            comparisonHTML += createComparisonRow('Total (Hora)', oldData.TOTAL_EM_HORA, currentData.TOTAL_EM_HORA);
                            comparisonHTML += createComparisonRow('Total Negativo', oldData.TOTAL_NEGATIVO, currentData.TOTAL_NEGATIVO);
                            comparisonHTML += createComparisonRow('Valor Pgto. BH', oldData.VAL_PGTO_BHS, currentData.VAL_PGTO_BHS);
                            comparisonHTML += createComparisonRow('Total Geral', oldData['Total Geral'], currentData['Total Geral']);

                            ui.modalComparison.innerHTML = comparisonHTML;
                        } else {
                            ui.modalNoHistory.classList.remove('hidden');
                        }
                    }

                } catch (err) {
                    console.error("Erro ao buscar detalhes:", err);
                    ui.modalBody.innerHTML = `<p class="text-red-500">${err.message}</p>`;
                } finally {
                    showLoading(false);
                }
            }

            /**
             * Converte texto (CSV/TSV) para um array de objetos.
             */
            function parsePastedData(text) {
                const lines = text.trim().split('\n');
                if (lines.length < 2) throw new Error("Os dados precisam de pelo menos 2 linhas (cabeçalho e dados).");

                const delimiter = lines[0].includes('\t') ? '\t' : ',';
                const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                
                // Valida cabeçalhos
                const missingHeaders = COLUMN_ORDER.filter(col => !headers.includes(col));
                if (missingHeaders.length > 0) {
                    throw new Error(`Cabeçalhos faltando: ${missingHeaders.join(', ')}`);
                }

                const data = lines.slice(1).map(line => {
                    const values = line.split(delimiter).map(v => v.trim().replace(/"/g, ''));
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index] || null;
                    });
                    if (!obj.CHAPA) {
                        throw new Error(`Linha sem "CHAPA" encontrada: ${line}`);
                    }
                    return obj;
                });

                return data;
            }

            /**
             * Lida com a importação de novos dados.
             */
            async function handleImport() {
                ui.importError.classList.add('hidden');
                const pastedData = ui.dataInput.value;
                if (!pastedData) {
                    showImportError("A área de texto está vazia.");
                    return;
                }

                let newData;
                try {
                    newData = parsePastedData(pastedData);
                } catch (err) {
                    showImportError(err.message);
                    return;
                }

                if (newData.length === 0) {
                    showImportError("Nenhum dado válido para importar.");
                    return;
                }

                showLoading(true, `Importando ${newData.length} registros...`);

                try {
                    // 1. Obter todos os dados atuais para o histórico
                    showLoading(true, `Etapa 1/4: Salvando histórico atual...`);
                    const currentDataSnap = await refs.data().get();
                    const currentData = currentDataSnap.docs.map(doc => doc.data());

                    // 2. Salvar o histórico (se houver dados)
                    if (currentData.length > 0) {
                        await refs.history().add({
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            data: currentData,
                            importedBy: state.userId
                        });
                    }

                    // 3. Atualizar/Inserir novos dados em lote
                    showLoading(true, `Etapa 2/4: Preparando novos dados...`);
                    const batch = state.db.batch();
                    newData.forEach(item => {
                        const docRef = refs.doc(item.CHAPA);
                        batch.set(docRef, item);
                    });

                    // (Opcional) Limpar dados antigos que não estão na nova lista
                    // showLoading(true, `Etapa 3/4: Removendo dados antigos...`);
                    // const newChapas = new Set(newData.map(item => String(item.CHAPA)));
                    // currentDataSnap.docs.forEach(doc => {
                    //     if (!newChapas.has(doc.id)) {
                    //         batch.delete(doc.ref);
                    //     }
                    // });

                    showLoading(true, `Etapa 3/4: Enviando dados...`);
                    await batch.commit();

                    // 4. Atualizar metadados
                    showLoading(true, `Etapa 4/4: Finalizando...`);
                    await refs.metadata().set({
                        lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: state.userId,
                        recordCount: newData.length
                    }, { merge: true });

                    ui.dataInput.value = ''; // Limpa o textarea
                    await loadAllData(); // Recarrega a tabela
                    showLoading(false);
                    alert("Dados importados com sucesso!");

                } catch (err) {
                    console.error("Erro durante a importação:", err);
                    showLoading(false);
                    showImportError(`Erro fatal: ${err.message}`);
                }
            }


            // --- INICIALIZAÇÃO E EVENTOS ---

            async function main() {
                showLoading(true, 'Conectando...');
                await initializeFirebase();
                if (state.auth.currentUser) {
                    listenToMetadata();
                    renderTableHeader();
                    await loadAllData();

                    // Event Listeners
                    ui.importButton.addEventListener('click', handleImport);
                    ui.modalClose.addEventListener('click', () => ui.modal.style.display = 'none');
                    window.addEventListener('click', (event) => {
                        if (event.target == ui.modal) {
                            ui.modal.style.display = 'none';
                        }
                    });

                    // Filtros
                    [ui.filterChapa, ui.filterNome, ui.filterRegional, ui.filterCodFilial].forEach(input => {
                        input.addEventListener('input', applyFilters);
                    });
                }
            }

            main();
        });
    </script>

</body>
</html>
